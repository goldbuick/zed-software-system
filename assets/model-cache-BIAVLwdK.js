import{i as f,B as m}from"./index-CVQSJhIg.js";class l{dbName="kitten-tts-cache";storeName="models";version=1;db=null;async init(){return this.db?this.db:new Promise((t,s)=>{const e=indexedDB.open(this.dbName,this.version);e.onerror=()=>s(e.error),e.onsuccess=()=>{this.db=e.result,t(this.db)},e.onupgradeneeded=a=>{const n=a.target.result;n.objectStoreNames.contains(this.storeName)||n.createObjectStore(this.storeName,{keyPath:"url"}).createIndex("timestamp","timestamp",{unique:!1})}})}async get(t){return await this.init(),new Promise((s,e)=>{if(!this.db)return e(new Error("IndexedDB not initialized"));const i=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).get(t);i.onerror=()=>e(i.error),i.onsuccess=()=>{const r=i.result;r?Date.now()-r.timestamp<6048e5?s(r.data):(this.delete(t),s(null)):s(null)}})}async set(t,s){return await this.init(),new Promise((e,a)=>{if(!this.db)return a(new Error("IndexedDB not initialized"));const r=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).put({url:t,data:s,timestamp:Date.now()});r.onerror=()=>a(r.error),r.onsuccess=()=>e()})}async delete(t){return await this.init(),new Promise((s,e)=>{if(!this.db)return e(new Error("IndexedDB not initialized"));const i=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(t);i.onerror=()=>e(i.error),i.onsuccess=()=>s()})}}const o=new Function("specifier","return import(specifier)");class h{baseDir;manifestPath;manifest;maxAge;initialized;constructor(t=".cache/kitten-tts"){this.baseDir=t,this.manifestPath="",this.manifest={},this.maxAge=10080*60*1e3,this.initialized=!1}async init(){if(this.initialized)return;const t=await o("path"),s=await o("fs");this.baseDir=t.resolve(this.baseDir),this.manifestPath=t.join(this.baseDir,"cache-manifest.json"),s.existsSync(this.baseDir)||s.mkdirSync(this.baseDir,{recursive:!0}),this.manifest=await this._loadManifest(),this.initialized=!0}async _loadManifest(){const t=await o("fs");try{if(t.existsSync(this.manifestPath))return JSON.parse(t.readFileSync(this.manifestPath,"utf8"))}catch(s){console.warn("Failed to load manifest:",s)}return{}}async _saveManifest(){(await o("fs")).writeFileSync(this.manifestPath,JSON.stringify(this.manifest,null,2))}_sanitizeFileName(t,s="application/octet-stream"){const e=this._inferExtension(s);return`${m.from(t).toString("base64").replace(/[^\w]/g,"")}.${e}`}_inferExtension(t){const s=t.split(";")[0].trim();return{"application/octet-stream":"bin","application/wasm":"wasm","application/json":"json","application/javascript":"js","text/plain":"txt","text/html":"html","audio/wav":"wav","audio/mpeg":"mp3","audio/ogg":"ogg","model/onnx":"onnx"}[s]||s.split("/").pop()||"bin"}async get(t){await this.init();const s=await o("fs"),e=this.manifest[t];if(!e)return null;if(!s.existsSync(e.filePath))return delete this.manifest[t],await this._saveManifest(),null;if(Date.now()-e.timestamp>this.maxAge)return s.unlinkSync(e.filePath),delete this.manifest[t],await this._saveManifest(),null;const n=s.readFileSync(e.filePath);return n.buffer.slice(n.byteOffset,n.byteOffset+n.byteLength)}async set(t,s,e="application/octet-stream"){await this.init();const a=await o("path"),n=await o("fs"),i=this._sanitizeFileName(t,e),r=a.join(this.baseDir,i);n.writeFileSync(r,m.from(s)),this.manifest[t]={url:t,filePath:r,mimeType:e,timestamp:Date.now()},await this._saveManifest()}async getLocalPath(t){await this.init();const s=await o("fs"),e=this.manifest[t];return e&&s.existsSync(e.filePath)?e.filePath:null}}async function w(c){const t=f()?new l:new h;t instanceof h&&await t.init();const s=await t.get(c);if(s){const i=new Headers;if(!f()&&t instanceof h){const r=t.manifest[c];r?.mimeType&&i.set("Content-Type",r.mimeType)}return new Response(s,{headers:i})}const e=await fetch(c);if(!e.ok)throw new Error(`HTTP error: ${e.status}`);const a=await e.arrayBuffer(),n=e.headers.get("Content-Type")||"application/octet-stream";return!f()&&t instanceof h?await t.set(c,a,n):t instanceof l&&await t.set(c,a),new Response(a,{status:e.status,statusText:e.statusText,headers:e.headers})}export{l as ModelCache,h as NodeCache,w as cachedFetch};
