{"version":3,"sources":["../../../../../../packages/vite/src/executors/build/build.impl.ts"],"sourcesContent":["import 'dotenv/config';\nimport { ExecutorContext } from '@nrwl/devkit';\nimport { build, InlineConfig, mergeConfig } from 'vite';\nimport {\n  getViteBuildOptions,\n  getViteSharedConfig,\n} from '../../utils/options-utils';\nimport { ViteBuildExecutorOptions } from './schema';\nimport { copyAssets } from '@nrwl/js';\nimport { existsSync } from 'fs';\nimport { resolve } from 'path';\nimport { createAsyncIterable } from '@nrwl/devkit/src/utils/async-iterable';\n\nexport async function* viteBuildExecutor(\n  options: ViteBuildExecutorOptions,\n  context: ExecutorContext\n) {\n  const normalizedOptions = normalizeOptions(options);\n  const projectRoot =\n    context.projectsConfigurations.projects[context.projectName].root;\n\n  const buildConfig = mergeConfig(\n    getViteSharedConfig(normalizedOptions, false, context),\n    {\n      build: getViteBuildOptions(normalizedOptions, context),\n    }\n  );\n\n  const watcherOrOutput = await runInstance(buildConfig);\n\n  const libraryPackageJson = resolve(projectRoot, 'package.json');\n  const rootPackageJson = resolve(context.root, 'package.json');\n\n  // For buildable libs, copy package.json if it exists.\n  if (\n    existsSync(libraryPackageJson) &&\n    rootPackageJson !== libraryPackageJson\n  ) {\n    await copyAssets(\n      {\n        outputPath: normalizedOptions.outputPath,\n        assets: [\n          {\n            input: projectRoot,\n            output: '.',\n            glob: 'package.json',\n          },\n        ],\n      },\n      context\n    );\n  }\n\n  if ('on' in watcherOrOutput) {\n    const iterable = createAsyncIterable<{ success: boolean }>(({ next }) => {\n      let success = true;\n      watcherOrOutput.on('event', (event) => {\n        if (event.code === 'START') {\n          success = true;\n        } else if (event.code === 'ERROR') {\n          success = false;\n        } else if (event.code === 'END') {\n          next({ success });\n        }\n        // result must be closed when present.\n        // see https://rollupjs.org/guide/en/#rollupwatch\n        if ('result' in event) {\n          event.result.close();\n        }\n      });\n    });\n    yield* iterable;\n  } else {\n    yield { success: true };\n  }\n}\n\nfunction runInstance(options: InlineConfig) {\n  return build({\n    ...options,\n  });\n}\n\nfunction normalizeOptions(options: ViteBuildExecutorOptions) {\n  const normalizedOptions = { ...options };\n\n  // coerce watch to null or {} to match with Vite's watch config\n  if (options.watch === false) {\n    normalizedOptions.watch = null;\n  } else if (options.watch === true) {\n    normalizedOptions.watch = {};\n  }\n\n  return normalizedOptions;\n}\n\nexport default viteBuildExecutor;\n"],"names":["viteBuildExecutor","options","context","normalizedOptions","normalizeOptions","projectRoot","projectsConfigurations","projects","projectName","root","buildConfig","mergeConfig","getViteSharedConfig","build","getViteBuildOptions","watcherOrOutput","runInstance","libraryPackageJson","resolve","rootPackageJson","existsSync","copyAssets","outputPath","assets","input","output","glob","iterable","createAsyncIterable","next","success","on","event","code","result","close","watch"],"mappings":"AAAA;;;;;;;;IAauBA,iBAAiB,MAAjBA;IAmFvB,OAAiC,MAAjC;;;QAhGO;sBAE0C;8BAI1C;oBAEoB;oBACA;sBACH;+BACY;AAE7B,gBAAgBA,kBACrBC,OAAiC,EACjCC,OAAwB,EACxB;IACA,MAAMC,oBAAoBC,iBAAiBH;IAC3C,MAAMI,cACJH,QAAQI,sBAAsB,CAACC,QAAQ,CAACL,QAAQM,WAAW,CAAC,CAACC,IAAI;IAEnE,MAAMC,cAAcC,IAAAA,iBAAW,EAC7BC,IAAAA,iCAAmB,EAACT,mBAAmB,KAAK,EAAED,UAC9C;QACEW,OAAOC,IAAAA,iCAAmB,EAACX,mBAAmBD;IAChD;IAGF,MAAMa,kBAAkB,MAAMC,YAAYN;IAE1C,MAAMO,qBAAqBC,IAAAA,aAAO,EAACb,aAAa;IAChD,MAAMc,kBAAkBD,IAAAA,aAAO,EAAChB,QAAQO,IAAI,EAAE;IAE9C,sDAAsD;IACtD,IACEW,IAAAA,cAAU,EAACH,uBACXE,oBAAoBF,oBACpB;QACA,MAAMI,IAAAA,cAAU,EACd;YACEC,YAAYnB,kBAAkBmB,UAAU;YACxCC,QAAQ;gBACN;oBACEC,OAAOnB;oBACPoB,QAAQ;oBACRC,MAAM;gBACR;aACD;QACH,GACAxB;IAEJ,CAAC;IAED,IAAI,QAAQa,iBAAiB;QAC3B,MAAMY,WAAWC,IAAAA,kCAAmB,EAAuB,CAAC,EAAEC,KAAI,EAAE,GAAK;YACvE,IAAIC,UAAU,IAAI;YAClBf,gBAAgBgB,EAAE,CAAC,SAAS,CAACC,QAAU;gBACrC,IAAIA,MAAMC,IAAI,KAAK,SAAS;oBAC1BH,UAAU,IAAI;gBAChB,OAAO,IAAIE,MAAMC,IAAI,KAAK,SAAS;oBACjCH,UAAU,KAAK;gBACjB,OAAO,IAAIE,MAAMC,IAAI,KAAK,OAAO;oBAC/BJ,KAAK;wBAAEC;oBAAQ;gBACjB,CAAC;gBACD,sCAAsC;gBACtC,iDAAiD;gBACjD,IAAI,YAAYE,OAAO;oBACrBA,MAAME,MAAM,CAACC,KAAK;gBACpB,CAAC;YACH;QACF;QACA,OAAOR;IACT,OAAO;QACL,MAAM;YAAEG,SAAS,IAAI;QAAC;IACxB,CAAC;AACH;AAEA,SAASd,YAAYf,OAAqB,EAAE;IAC1C,OAAOY,IAAAA,WAAK,EAAC,aACRZ;AAEP;AAEA,SAASG,iBAAiBH,OAAiC,EAAE;IAC3D,MAAME,oBAAoB,aAAKF;IAE/B,+DAA+D;IAC/D,IAAIA,QAAQmC,KAAK,KAAK,KAAK,EAAE;QAC3BjC,kBAAkBiC,KAAK,GAAG,IAAI;IAChC,OAAO,IAAInC,QAAQmC,KAAK,KAAK,IAAI,EAAE;QACjCjC,kBAAkBiC,KAAK,GAAG,CAAC;IAC7B,CAAC;IAED,OAAOjC;AACT;MAEA,WAAeH"}