const a1_0x9b42=['throw','tasks-hashes-','assign','EndOfRunMessage','then','daemon','runUrl','getBranch','DISTRIBUTED_TASK_EXECUTION_INTERNAL_ERROR_STATUS_CODE','extractGitSha','../../api/error-reporter.api','enabled','filter','all','Nx\x20Cloud\x20Problems','printMessages','\x20isn\x27t\x20recorded','ENCRYPTION_KEY','local-cache-hit','done','../../file-storage/e2e-encryption','.commit','getRunGroup','toISOString','note','obfuscate','error','complete','cloudEnabledTasksRunner','./cloud-remote-cache','catch','message','rxjs/internal/Subject','push','Executed\x20tasks\x20with\x20hashes:\x20','warn','Nx\x20Cloud\x20wasn\x27t\x20able\x20to\x20store\x20artifacts.','value','parseCommand','https://nx.app','next','pathExists','/runs/','scan','taskId','printCacheHitsMessage','forEach','defineProperty','CloudEnabledLifeCycle','find','@nrwl/nx-cloud/lib/daemon/process-run-end','fs-extra','map','accessToken','CloudRunApi','hash','./id-generator','ErrorReporterApi','CloudRemoteCache','requests','../../terminal-output/output-obfuscator','exit','getNxCacheDirectory','maskedProperties','NX_CLOUD_DISTRIBUTED_EXECUTION_ID','./cloud-enabled-life-cycle','Task\x20with\x20hash\x20','encryptionKey','__esModule','delayedStoreRequests','__awaiter','waitForStoreRequestsToComplete','startRun','length','env','VERBOSE_LOGGING','store','ACCESS_TOKEN','subscribe','../../terminal-output/message-reporter','join','../../../utilities/metric-logger','processInBackground','agentRunningInDistributedExecution','path'];(function(_0x139cbb,_0x9b4238){const _0xb90010=function(_0x3d2d3e){while(--_0x3d2d3e){_0x139cbb['push'](_0x139cbb['shift']());}};_0xb90010(++_0x9b4238);}(a1_0x9b42,0xb6));const a1_0xb900=function(_0x139cbb,_0x9b4238){_0x139cbb=_0x139cbb-0x0;let _0xb90010=a1_0x9b42[_0x139cbb];return _0xb90010;};'use strict';var __awaiter=this&&this[a1_0xb900('0x3a')]||function(_0x2450ca,_0x12e52f,_0x182d5a,_0x3dde97){function _0x6a3ff6(_0x27116c){return _0x27116c instanceof _0x182d5a?_0x27116c:new _0x182d5a(function(_0x350181){_0x350181(_0x27116c);});}return new(_0x182d5a||(_0x182d5a=Promise))(function(_0x231fb8,_0x2537d6){function _0x4dde1a(_0x2c51f8){try{_0x25d379(_0x3dde97[a1_0xb900('0x1c')](_0x2c51f8));}catch(_0x5d55b2){_0x2537d6(_0x5d55b2);}}function _0x5b6205(_0x29bbba){try{_0x25d379(_0x3dde97[a1_0xb900('0x49')](_0x29bbba));}catch(_0x4d6db8){_0x2537d6(_0x4d6db8);}}function _0x25d379(_0x597d9c){_0x597d9c[a1_0xb900('0x7')]?_0x231fb8(_0x597d9c[a1_0xb900('0x19')]):_0x6a3ff6(_0x597d9c[a1_0xb900('0x19')])[a1_0xb900('0x4d')](_0x4dde1a,_0x5b6205);}_0x25d379((_0x3dde97=_0x3dde97['apply'](_0x2450ca,_0x12e52f||[]))[a1_0xb900('0x1c')]());});};Object[a1_0xb900('0x23')](exports,a1_0xb900('0x38'),{'value':!![]});exports[a1_0xb900('0x10')]=void 0x0;const message_reporter_1=require(a1_0xb900('0x43'));const end_of_run_message_1=require('../../terminal-output/end-of-run-message');const output_obfuscator_1=require(a1_0xb900('0x30'));const cloud_enabled_life_cycle_1=require(a1_0xb900('0x35'));const file_storage_1=require('../../file-storage/file-storage');const e2e_encryption_1=require(a1_0xb900('0x8'));const environment_1=require('../../../utilities/environment');const cloud_remote_cache_1=require(a1_0xb900('0x11'));const cloud_run_api_1=require('./cloud-run.api');const fs_1=require('fs');const path=require(a1_0xb900('0x48'));const path_1=require(a1_0xb900('0x48'));const metric_logger_1=require(a1_0xb900('0x45'));const error_reporter_api_1=require(a1_0xb900('0x53'));const fs_extra_1=require(a1_0xb900('0x27'));const id_generator_1=require(a1_0xb900('0x2c'));const {tasksRunner,output}=require('../../../utilities/nx-imports');function createApi(_0x229195,_0x5abd17,_0x17fcb4){const _0x7057f2=(0x0,environment_1['getMachineInfo'])(_0x5abd17);return new cloud_run_api_1[(a1_0xb900('0x2a'))](_0x229195,_0x17fcb4,_0x5abd17,_0x7057f2);}function storeTaskHashes(_0x7cd452,_0x1808e2,_0x456c83){const _0x3ce297=JSON['stringify'](_0x7cd452[a1_0xb900('0x28')](_0x27d917=>({'taskId':_0x27d917[a1_0xb900('0x20')],'hash':_0x27d917[a1_0xb900('0x2b')]})));if(environment_1[a1_0xb900('0x3f')]){output[a1_0xb900('0xc')]({'title':a1_0xb900('0x16')+_0x3ce297});}(0x0,fs_1['writeFileSync'])(path[a1_0xb900('0x44')](_0x1808e2,a1_0xb900('0x4a')+_0x456c83),_0x3ce297);}function storeLocalCacheHits(_0x285703,_0x3d1dff,_0x5b0bec){const _0x360e97=_0x285703[a1_0xb900('0x0')](_0xdb7747=>_0xdb7747['cacheStatus']===a1_0xb900('0x6'))[a1_0xb900('0x28')](_0x2b3f6e=>_0x2b3f6e[a1_0xb900('0x2b')]);_0x360e97[a1_0xb900('0x22')](_0x344a20=>_0x3d1dff[a1_0xb900('0x40')](_0x344a20,_0x5b0bec));}function onComplete({daemon,options,fileStorage,remoteCache,api,outputObfuscator,runStartTime,messages,endOfRunMessage,taskExecutions,versionOfNxBefore133,inner,encryptionKey,storeInCurrentProcess,distributedExecutionId,runContext}){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x4c952f=new Date()[a1_0xb900('0xb')]();const _0x17abe5=(0x0,environment_1[a1_0xb900('0x50')])();const _0x1e3ab0={'command':outputObfuscator[a1_0xb900('0xd')]((0x0,environment_1[a1_0xb900('0x1a')])()),'startTime':runStartTime,'endTime':_0x4c952f,'distributedExecutionId':distributedExecutionId,'branch':_0x17abe5,'scan':!![],'runGroup':(0x0,environment_1[a1_0xb900('0xa')])(),'sha':_0x17abe5?(0x0,environment_1[a1_0xb900('0x52')])():undefined,'inner':inner};if(storeInCurrentProcess){if((0x0,environment_1[a1_0xb900('0x47')])(distributedExecutionId)){const _0x8df260=(0x0,environment_1[a1_0xb900('0x32')])(options);storeTaskHashes(taskExecutions,_0x8df260,distributedExecutionId);storeLocalCacheHits(taskExecutions,remoteCache,_0x8df260);}try{yield remoteCache[a1_0xb900('0x3b')]();}catch(_0x2ba97f){output[a1_0xb900('0xe')]({'title':a1_0xb900('0x18')});messages['printMessages']();return![];}for(const _0x499546 of fileStorage['storedHashes']){const _0x450afe=taskExecutions[a1_0xb900('0x25')](_0x1237b1=>_0x1237b1['hash']===_0x499546);if(!_0x450afe){throw new Error(a1_0xb900('0x36')+_0x499546+a1_0xb900('0x4'));}_0x450afe['uploadedToStorage']=!![];}try{yield api['endRun'](_0x1e3ab0,taskExecutions);}catch(_0x2037bb){output[a1_0xb900('0xe')]({'title':'Nx\x20Cloud\x20wasn\x27t\x20able\x20to\x20record\x20its\x20run.'});messages[a1_0xb900('0x3')]();return![];}yield(0x0,metric_logger_1['submitRunMetrics'])(options);}else{try{const _0xc889a6=environment_1[a1_0xb900('0x41')]?environment_1[a1_0xb900('0x41')]:options[a1_0xb900('0x29')];const _0x43a5ea=(0x0,id_generator_1['generateUniqueLinkId'])();yield daemon[a1_0xb900('0x46')](a1_0xb900('0x26'),{'encryptionKey':encryptionKey,'runnerOptions':Object[a1_0xb900('0x4b')](Object[a1_0xb900('0x4b')]({},options),{'accessToken':_0xc889a6}),'delayedStoreRequests':remoteCache[a1_0xb900('0x39')],'runEnd':{'runData':_0x1e3ab0,'taskExecutions':taskExecutions,'linkId':_0x43a5ea}});runContext[a1_0xb900('0x4f')]=(options['url']||a1_0xb900('0x1b'))+a1_0xb900('0x1e')+_0x43a5ea;}catch(_0x10486d){output[a1_0xb900('0x17')]({'title':a1_0xb900('0x2'),'bodyLines':[_0x10486d[a1_0xb900('0x13')]||_0x10486d['toString']()]});return![];}}if(versionOfNxBefore133){setTimeout(()=>{messages[a1_0xb900('0x3')]();if(!messages['anyErrors']&&!inner){endOfRunMessage[a1_0xb900('0x21')]();}},0x0);}else{messages[a1_0xb900('0x3')]();if(!messages['anyErrors']&&!inner){endOfRunMessage[a1_0xb900('0x21')]();}}return!![];});}function createLifeCycle(_0x5e582e,_0x34e0f1,_0x3956fb,_0x5a93fc){const _0x2cab9b=new cloud_enabled_life_cycle_1[(a1_0xb900('0x24'))](_0x5e582e,(0x0,environment_1[a1_0xb900('0x32')])(_0x34e0f1),_0x34e0f1[a1_0xb900('0x1f')]===undefined?!![]:_0x34e0f1[a1_0xb900('0x1f')],_0x34e0f1['cacheableOperations']||[],_0x3956fb,_0x5a93fc);try{const {CompositeLifeCycle}=require('../../../utilities/nx-imports');if(!CompositeLifeCycle)return _0x2cab9b;return new CompositeLifeCycle([_0x34e0f1['lifeCycle'],_0x2cab9b]);}catch(_0x5a65c6){return _0x2cab9b;}}function fetchUrlsForKnownHashesUpfront(_0x2af877,_0x2b96ae,_0x3ec5d2,_0x5b333b,_0x37587d){return __awaiter(this,void 0x0,void 0x0,function*(){if(_0x5b333b['skipNxCache'])return;let _0x150f45=_0x3ec5d2[a1_0xb900('0x28')](_0x32ff11=>_0x32ff11[a1_0xb900('0x2b')])[a1_0xb900('0x0')](_0x161ab7=>!!_0x161ab7);const _0x5ac46b=(0x0,environment_1[a1_0xb900('0x32')])(_0x5b333b);const _0x3ddf28=yield Promise[a1_0xb900('0x1')](_0x150f45[a1_0xb900('0x28')](_0x3538a5=>{const _0x55a479=(0x0,path_1[a1_0xb900('0x44')])(_0x5ac46b,_0x3538a5+a1_0xb900('0x9'));return(0x0,fs_extra_1[a1_0xb900('0x1d')])(_0x55a479);}));const _0x38c2fb=[];for(let _0x33f013=0x0;_0x33f013<_0x3ddf28[a1_0xb900('0x3d')];++_0x33f013){if(!_0x3ddf28[_0x33f013]){_0x38c2fb[a1_0xb900('0x15')](_0x150f45[_0x33f013]);}}if(_0x38c2fb[a1_0xb900('0x3d')]>0x0){const _0x3a871c=_0x2af877[a1_0xb900('0x3c')](_0x37587d,_0x38c2fb);for(const _0x573d85 of _0x38c2fb){_0x2b96ae[a1_0xb900('0x2f')][_0x573d85]=_0x3a871c;}}});}function cloudEnabledTasksRunner(_0x9412d7,_0x4fc6c7,_0x252a1b,_0x365842=![]){var _0x1ab436;const _0x2cf2a8=process[a1_0xb900('0x3e')][a1_0xb900('0x34')];const _0x47de89={'statuses':{},'scheduledTasks':[],'requests':{},'allTasks':_0x9412d7};const _0x3ae4dd=_0x4fc6c7['lifeCycle']===undefined;const _0x3db215=[];const _0x1edab3=new message_reporter_1['MessageReporter'](_0x4fc6c7);const _0x4a36ce=createApi(_0x1edab3,_0x4fc6c7,_0x47de89);const _0x12a4d0=new end_of_run_message_1[(a1_0xb900('0x4c'))](_0x47de89,_0x3db215,_0x2cf2a8);const _0x6f9cc4=new output_obfuscator_1['OutputObfuscator'](_0x4fc6c7[a1_0xb900('0x33')]);const _0x3eefaf=new Date()[a1_0xb900('0xb')]();const _0x6d376a=createLifeCycle(_0x47de89,_0x4fc6c7,_0x6f9cc4,_0x3db215);const _0x2aa6a6=environment_1[a1_0xb900('0x5')]||_0x4fc6c7[a1_0xb900('0x37')];const _0x2f57d4=new e2e_encryption_1['E2EEncryption'](_0x2aa6a6);const _0x7cc36a=new error_reporter_api_1[(a1_0xb900('0x2d'))](_0x4fc6c7);const _0x49bd30=(0x0,environment_1['agentRunningInDistributedExecution'])(_0x2cf2a8)||!((_0x1ab436=_0x252a1b['daemon'])===null||_0x1ab436===void 0x0?void 0x0:_0x1ab436[a1_0xb900('0x54')]());const _0x21f434=new file_storage_1['FileStorage'](_0x2f57d4,_0x7cc36a);const _0x537d9f=new cloud_remote_cache_1[(a1_0xb900('0x2e'))](_0x1edab3,_0x4a36ce,_0x47de89,_0x21f434,_0x2cf2a8,_0x49bd30);fetchUrlsForKnownHashesUpfront(_0x4a36ce,_0x47de89,_0x9412d7,_0x4fc6c7,_0x2cf2a8);delete process[a1_0xb900('0x3e')][a1_0xb900('0x34')];const _0x4a4926=tasksRunner(_0x9412d7,Object['assign'](Object['assign']({},_0x4fc6c7),{'remoteCache':_0x537d9f,'lifeCycle':_0x6d376a}),_0x252a1b);if(_0x4a4926[a1_0xb900('0x42')]){const {Subject}=require(a1_0xb900('0x14'));const _0x173382=new Subject();_0x4a4926[a1_0xb900('0x42')]({'next':_0x4fa50f=>_0x173382[a1_0xb900('0x1c')](_0x4fa50f),'error':_0x9f331f=>_0x173382['error'](_0x9f331f),'complete':()=>__awaiter(this,void 0x0,void 0x0,function*(){const _0x2d3154=yield onComplete({'daemon':_0x252a1b['daemon'],'options':_0x4fc6c7,'fileStorage':_0x21f434,'remoteCache':_0x537d9f,'api':_0x4a36ce,'outputObfuscator':_0x6f9cc4,'runStartTime':_0x3eefaf,'messages':_0x1edab3,'endOfRunMessage':_0x12a4d0,'taskExecutions':_0x3db215,'versionOfNxBefore133':_0x3ae4dd,'inner':_0x365842,'encryptionKey':_0x2aa6a6,'storeInCurrentProcess':_0x49bd30,'runContext':_0x47de89,'distributedExecutionId':_0x2cf2a8});if(!_0x2d3154&&(0x0,environment_1[a1_0xb900('0x47')])(_0x2cf2a8)){process[a1_0xb900('0x31')](environment_1[a1_0xb900('0x51')]);}_0x173382[a1_0xb900('0xf')]();})});return _0x173382;}else{return _0x4a4926[a1_0xb900('0x4d')](_0x2e4ef8=>__awaiter(this,void 0x0,void 0x0,function*(){const _0x56d539=yield onComplete({'daemon':_0x252a1b['daemon'],'options':_0x4fc6c7,'fileStorage':_0x21f434,'remoteCache':_0x537d9f,'api':_0x4a36ce,'outputObfuscator':_0x6f9cc4,'runStartTime':_0x3eefaf,'messages':_0x1edab3,'endOfRunMessage':_0x12a4d0,'taskExecutions':_0x3db215,'versionOfNxBefore133':_0x3ae4dd,'inner':_0x365842,'encryptionKey':_0x2aa6a6,'storeInCurrentProcess':_0x49bd30,'runContext':_0x47de89,'distributedExecutionId':_0x2cf2a8});if(!_0x56d539&&(0x0,environment_1[a1_0xb900('0x47')])(_0x2cf2a8)){process[a1_0xb900('0x31')](environment_1['DISTRIBUTED_TASK_EXECUTION_INTERNAL_ERROR_STATUS_CODE']);}return _0x2e4ef8;}))[a1_0xb900('0x12')](_0x57294e=>__awaiter(this,void 0x0,void 0x0,function*(){const _0x5c2b29=yield onComplete({'daemon':_0x252a1b[a1_0xb900('0x4e')],'options':_0x4fc6c7,'fileStorage':_0x21f434,'remoteCache':_0x537d9f,'api':_0x4a36ce,'outputObfuscator':_0x6f9cc4,'runStartTime':_0x3eefaf,'messages':_0x1edab3,'endOfRunMessage':_0x12a4d0,'taskExecutions':_0x3db215,'versionOfNxBefore133':_0x3ae4dd,'inner':_0x365842,'encryptionKey':_0x2aa6a6,'storeInCurrentProcess':_0x49bd30,'runContext':_0x47de89,'distributedExecutionId':_0x2cf2a8});if(!_0x5c2b29&&(0x0,environment_1['agentRunningInDistributedExecution'])(_0x2cf2a8)){process[a1_0xb900('0x31')](environment_1[a1_0xb900('0x51')]);}throw _0x57294e;}));}}exports['cloudEnabledTasksRunner']=cloudEnabledTasksRunner;